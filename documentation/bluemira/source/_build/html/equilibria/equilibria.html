

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>equilibria &mdash; bluemira 0+untagged.82.gb22672a.dirty documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="geometry" href="../geometry.html" />
    <link rel="prev" title="base" href="../base.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> bluemira
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../started.html">Getting Started</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../modules.html">Bluemira Modules</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../base.html">base</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">equilibria</a></li>
<li class="toctree-l2"><a class="reference internal" href="#theory">Theory</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#the-ideal-mhd-plasma-equilibrium-problem">The ideal MHD plasma equilibrium problem</a></li>
<li class="toctree-l3"><a class="reference internal" href="#free-boundary-equilibrium-solver">Free boundary equilibrium solver</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#finite-difference-solution-to-the-grad-shafranov-equation">Finite difference solution to the Grad-Shafranov equation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#domain-boundary-conditions">Domain boundary conditions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#external-coils">External coils</a></li>
<li class="toctree-l4"><a class="reference internal" href="#plasma-boundary-identification">Plasma boundary identification</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#application-to-reactor-design">Application to reactor design</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#plasma-profiles">Plasma profiles</a></li>
<li class="toctree-l4"><a class="reference internal" href="#equilibrium-constraints">Equilibrium constraints</a></li>
<li class="toctree-l4"><a class="reference internal" href="#coil-current-force-and-field-constraints">Coil current, force, and field constraints</a></li>
<li class="toctree-l4"><a class="reference internal" href="#coil-position-optimisation-and-constraints">Coil position optimisation and constraints</a></li>
<li class="toctree-l4"><a class="reference internal" href="#appendix-1-greens-functions-and-discretised-coils">Appendix 1: Green’s functions and discretised coils</a></li>
<li class="toctree-l4"><a class="reference internal" href="#appendix-2-optimisation-jacobians">Appendix 2: optimisation Jacobians</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../geometry.html">geometry</a></li>
<li class="toctree-l2"><a class="reference internal" href="../utilities.html">utilities</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../autoapi/index.html">Module Reference</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">bluemira</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../modules.html">Bluemira Modules</a> &raquo;</li>
        
      <li>equilibria</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/equilibria/equilibria.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="equilibria">
<h1>equilibria<a class="headerlink" href="#equilibria" title="Permalink to this headline">¶</a></h1>
</div>
<div class="section" id="theory">
<h1>Theory<a class="headerlink" href="#theory" title="Permalink to this headline">¶</a></h1>
<p>The following documentation is mostly an extract from: <a class="reference external" href="https://doi.org/10.1016/j.fusengdes.2020.111544">The design and optimisation of tokamak poloidal field systems in the BLUEPRINT framework</a>, Coleman and McIntosh, <em>Fusion Engineering and Design</em> v <strong>154</strong> 111544 (2020).</p>
<div class="section" id="the-ideal-mhd-plasma-equilibrium-problem">
<h2>The ideal MHD plasma equilibrium problem<a class="headerlink" href="#the-ideal-mhd-plasma-equilibrium-problem" title="Permalink to this headline">¶</a></h2>
<p>The two-dimensional axisymmetric ideal magneto-hydrodynamic (MHD) plasma
equilibrium in cylindrical coordinates (<span class="math notranslate nohighlight">\(X, \phi, Z\)</span>) is described
by the well-known Grad-Shafranov equation <a class="reference internal" href="#shafranov-1957" id="id1"><span>[Shafranov_1957]</span></a>, <a class="reference internal" href="#grad-1958" id="id2"><span>[Grad_1958]</span></a>,
in which the contribution of external coil currents can be included:</p>
<div class="math notranslate nohighlight" id="equation-gs1">
<span class="eqno">(1)<a class="headerlink" href="#equation-gs1" title="Permalink to this equation">¶</a></span>\[\Delta^{*}\psi = -\mu_0 X J_{\phi}\]</div>
<div class="math notranslate nohighlight" id="equation-gs2">
<span class="eqno">(2)<a class="headerlink" href="#equation-gs2" title="Permalink to this equation">¶</a></span>\[J_{\phi} = J_{\phi,pl}+J_{\phi,coils}\]</div>
<div class="math notranslate nohighlight" id="equation-gs3">
<span class="eqno">(3)<a class="headerlink" href="#equation-gs3" title="Permalink to this equation">¶</a></span>\[J_{\phi,pl} = X\dfrac{\partial{p(\psi)}}{\partial{\psi}}+\dfrac{F(\psi)}{\mu_0 X}\dfrac{\partial{F(\psi)}}{\partial{\psi}}\]</div>
<p>where:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(\Delta^{*} \equiv \dfrac{\partial^2\psi}{\partial Z^2}+X\dfrac{\partial}{\partial X}\bigg(\dfrac{1}{X}\dfrac{\partial \psi}{\partial X} \bigg)\)</span>
is the Grad-Shafranov operator</p></li>
<li><p><span class="math notranslate nohighlight">\(\mu_0=4\pi\times 10^{-7}\)</span> is the permeability of vacuum (in
V.s/(A.m))</p></li>
<li><p><span class="math notranslate nohighlight">\(\psi(X, Z)\)</span> is the poloidal magnetic flux per radian (in
V.s/rad)</p></li>
<li><p><span class="math notranslate nohighlight">\(J_{\phi,pl}\)</span> is the toroidal current density in the plasma (in
A/m<sup>2</sup>)</p></li>
<li><p><span class="math notranslate nohighlight">\(J_{\phi,coils}\)</span> is the toroidal current density in the coils
(in A/m<sup>2</sup>)</p></li>
<li><p><span class="math notranslate nohighlight">\(p(\psi)\)</span> is the plasma pressure profile (in Pa)</p></li>
<li><p><span class="math notranslate nohighlight">\(F(\psi)\)</span> is the toroidal magnetic field profile (in T.m),
which is a function of the toroidal field, <span class="math notranslate nohighlight">\(B_{\phi}\)</span></p></li>
</ul>
<p>For the control of integral plasma values, it is convenient to choose an
alternative representation of the plasma current profile, following <a class="reference internal" href="#luxon-1982" id="id3"><span>[Luxon_1982]</span></a>, which substitutes the equation above:</p>
<div class="math notranslate nohighlight" id="equation-jphi">
<span class="eqno">(4)<a class="headerlink" href="#equation-jphi" title="Permalink to this equation">¶</a></span>\[\begin{split}J_{\phi,pl} =
\begin{cases}
    &amp; \lambda \bigg(\beta_0\frac{X}{R_0}+(1-\beta_0)\frac{R_0}{X}\bigg) g\big(\overline{\psi}, \boldsymbol{\alpha}\big)~~\forall (X,Z) \in \Omega_p \\
    &amp; 0~~~\textrm{elsewhere}
\end{cases}\end{split}\]</div>
<p>where:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(R_0\)</span> is a characteristic length, taken to be the reactor major
radius (in m)</p></li>
<li><p><span class="math notranslate nohighlight">\(\lambda\)</span> and <span class="math notranslate nohighlight">\(\beta_0\)</span> are variables which affect plasma
integral values</p></li>
<li><p><span class="math notranslate nohighlight">\(g\big(\overline{\psi}, \boldsymbol{\alpha}\big)\)</span> is a function of the
normalised poloidal magnetic flux, <span class="math notranslate nohighlight">\(\overline{\psi}\)</span>, (i.e. a
flux function - see below).</p></li>
</ul>
<p><span class="math notranslate nohighlight">\(\overline{\psi}\)</span> is 0 at the magnetic axis, and 1 at the plasma
boundary:</p>
<div class="math notranslate nohighlight">
\[\overline{\psi}=\dfrac{\psi-\psi_a}{\psi_b-\psi_a}\]</div>
<p>Common flux function parameterisations include double power functions, Luxon exponentials <a class="reference internal" href="#luxon-1982" id="id4"><span>[Luxon_1982]</span></a>, and Lao polynomials <a class="reference internal" href="#lao-1985" id="id5"><span>[Lao_1985]</span></a>. In the following, a double power flux function parameterisation is used as it is usually appropriate for H-mode plasmas with high <span class="math notranslate nohighlight">\(\beta_p\)</span> and monotonically increasing <span class="math notranslate nohighlight">\(q\)</span> profiles.</p>
<div class="math notranslate nohighlight" id="equation-g1">
<span class="eqno">(5)<a class="headerlink" href="#equation-g1" title="Permalink to this equation">¶</a></span>\[g\big(\overline{\psi},\boldsymbol{\alpha}\big) = \bigg(1-{\overline{\psi}}^{~\alpha_1}\bigg)^{\alpha_2}\]</div>
<div class="math notranslate nohighlight" id="equation-g2">
<span class="eqno">(6)<a class="headerlink" href="#equation-g2" title="Permalink to this equation">¶</a></span>\[g\big(\overline{\psi},\boldsymbol{\alpha}\big) = \sum_{n=0}^{N}\alpha_{n+1}\overline{\psi}^{~n+1}-\overline{\psi}^{~N+1}\sum_{n=0}^{N} \alpha_{n+1}\]</div>
<div class="math notranslate nohighlight" id="equation-g3">
<span class="eqno">(7)<a class="headerlink" href="#equation-g3" title="Permalink to this equation">¶</a></span>\[g\big(\overline{\psi},\boldsymbol{\alpha}\big) = \textrm{exp}\bigg(-\alpha_1^2\overline{\psi}^{~2}\bigg)\]</div>
<p>where <span class="math notranslate nohighlight">\(\boldsymbol{\alpha} = (\alpha_1, \alpha_2, .., \alpha_N)\)</span> is the vector of flux
function shaping parameters.</p>
</div>
<div class="section" id="free-boundary-equilibrium-solver">
<h2>Free boundary equilibrium solver<a class="headerlink" href="#free-boundary-equilibrium-solver" title="Permalink to this headline">¶</a></h2>
<p>The Grad-Shafranov equation has <span class="math notranslate nohighlight">\(\psi\)</span> terms on both sides, and is
as such a non-linear problem.</p>
<p>Here, as with many other free boundary equilibrium codes, the problem is
divided into two parts: a finite difference formulation of the plasma
toroidal current, <span class="math notranslate nohighlight">\(J_{\phi,pl}\)</span>, and a “grid-free” calculation of
the contributions from external coil currents, <span class="math notranslate nohighlight">\(J_{\phi,coils}\)</span>,
using Green’s functions to represent point current sources.</p>
<div class="section" id="finite-difference-solution-to-the-grad-shafranov-equation">
<h3>Finite difference solution to the Grad-Shafranov equation<a class="headerlink" href="#finite-difference-solution-to-the-grad-shafranov-equation" title="Permalink to this headline">¶</a></h3>
<p>It is standard practice in Poisson-type Grad-Shafranov solvers to treat
the plasma in a discretised manner, as its position is not known <em>a
priori</em> and the current distribution is non-uniform.</p>
<p>Equations <a class="reference internal" href="#equation-gs1">(1)</a> and <a class="reference internal" href="#equation-gs3">(3)</a> can be converted to a linear
equation using a common second-order centred finite difference approach
on a uniform rectangular <span class="math notranslate nohighlight">\(n_x\)</span> by <span class="math notranslate nohighlight">\(n_z\)</span> grid representing
the domain, <span class="math notranslate nohighlight">\(\Omega_{FD}\)</span>, as discussed in <a class="reference internal" href="#jeon-2015" id="id6"><span>[Jeon_2015]</span></a>. An identical scheme is followed here, see Equation <a class="reference internal" href="#equation-fd">(8)</a> and <a class="reference internal" href="#fig-domains"><span class="std std-numref">Fig. 1</span></a>. For our purposes, moderate discretisation is appropriate; in the following we take <span class="math notranslate nohighlight">\(n_x\)</span> = 65 and <span class="math notranslate nohighlight">\(n_z\)</span> = 65.</p>
<div class="math notranslate nohighlight" id="equation-fd">
<span class="eqno">(8)<a class="headerlink" href="#equation-fd" title="Permalink to this equation">¶</a></span>\[\begin{split}\begin{aligned}
\begin{split}
&amp;\dfrac{1}{(\Delta Z)^2}\psi_{i-1, j}+\bigg(\dfrac{1}{(\Delta X)^2}+\dfrac{1}{2X_j(\Delta X)}\bigg)\psi_{i, j-1}\\
&amp;+\Bigg(\dfrac{2}{(\Delta X)^2}+\dfrac{2}{(\Delta Z)^2}\Bigg)\psi_{i, j}
+\bigg(\dfrac{1}{(\Delta X)^2}-\dfrac{1}{2X_j(\Delta X)}\bigg)\psi_{i, j+1}\\
&amp;+\dfrac{1}{(\Delta Z)^2}\psi_{i+1, j}=-\mu_0 X_j J_{\phi,pl}(X_i, Z_j)
\end{split}\end{aligned}\end{split}\]</div>
<p>where:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(\psi_{i,j} \equiv \psi(X_i, Z_j)\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(X_i\)</span> and <span class="math notranslate nohighlight">\(Z_j\)</span> correspond to the <span class="math notranslate nohighlight">\(i\)</span>-th and
<span class="math notranslate nohighlight">\(j\)</span>-th grid point, respectively, with <span class="math notranslate nohighlight">\(i = 2, .., n_x-1\)</span>
and <span class="math notranslate nohighlight">\(j = 2, .., n_z-1\)</span></p></li>
</ul>
<div class="figure align-default" id="fig-domains">
<img alt="../_images/coordinates_grid_domain_crop.png" src="../_images/coordinates_grid_domain_crop.png" />
<p class="caption"><span class="caption-number">Fig. 1 </span><span class="caption-text">Diagram depicting the (<span class="math notranslate nohighlight">\(X, \phi, Z\)</span>) coordinate system, the plasma domain and boundary, <span class="math notranslate nohighlight">\(\Omega_p\)</span> and <span class="math notranslate nohighlight">\(\partial\Omega_p\)</span>, the finite difference domain and boundary, <span class="math notranslate nohighlight">\(\Omega_{FD}\)</span> and <span class="math notranslate nohighlight">\(\partial\Omega_{FD}\)</span> (here <span class="math notranslate nohighlight">\(n_x=20\)</span> nd <span class="math notranslate nohighlight">\(n_z=25\)</span>), and an example set of discretised external CS and PF coils, which haved been numbered and named <em>à la</em> ITER.</span><a class="headerlink" href="#fig-domains" title="Permalink to this image">¶</a></p>
</div>
<p>Equation <a class="reference internal" href="#equation-fd">(8)</a> is then solved by reformulating it into a matrix
problem (i.e. <span class="math notranslate nohighlight">\(\mathbf{Ax}=\mathbf{b}\)</span>) which is solved for
<span class="math notranslate nohighlight">\(\mathbf{x}\)</span>, given the sparse Grad-Shafranov operator matrix,
<span class="math notranslate nohighlight">\(\mathbf{A}\)</span>, and a known boundary term, <span class="math notranslate nohighlight">\(\mathbf{b}\)</span>, (to
which a Dirichlet boundary condition is applied - discussed later).</p>
<p>The source term on the right-hand side, <span class="math notranslate nohighlight">\(J_{\phi,pl}\)</span>, is a strong
function of the <span class="math notranslate nohighlight">\(\psi\)</span> term on the left-hand side. To resolve this
non-linearity, a simple and commonly-used Picard iteration approach is
employed, such that:</p>
<div class="math notranslate nohighlight" id="equation-psisol">
<span class="eqno">(9)<a class="headerlink" href="#equation-psisol" title="Permalink to this equation">¶</a></span>\[\Delta^{*}\psi^{[n]} = -\mu_0 X J_{\phi,pl}^{[n]}(\psi^{[n-1]})\]</div>
<p>where <span class="math notranslate nohighlight">\(n\)</span> denotes the <span class="math notranslate nohighlight">\(n\)</span>-th Picard iteration. The iteration
is terminated when the solution is converged, according to a
user-specified criterion. Typically, we use
<span class="math notranslate nohighlight">\(\frac{\textrm{max}\lvert\psi^{[n-1]}-\psi^{[n]}\rvert}{\textrm{max}(\psi^{[n]})-\textrm{min}(\psi^{[n]})} \leq 10^{-3}\)</span>,
following <a class="reference internal" href="#dudson-2019" id="id7"><span>[Dudson_2019]</span></a>, as this criterion is
met fairly quickly and <em>generally</em> avoids the need for numerical
vertical stabilisation.</p>
</div>
<div class="section" id="domain-boundary-conditions">
<h3>Domain boundary conditions<a class="headerlink" href="#domain-boundary-conditions" title="Permalink to this headline">¶</a></h3>
<p>The boundary condition at the edge of the finite difference domain is
not constant, and changes at each iteration step.</p>
<p>A Dirichlet boundary condition is implemented such that at each
iteration step <span class="math notranslate nohighlight">\(\psi\)</span> is specified at the finite difference domain
boundary, <span class="math notranslate nohighlight">\(\partial\Omega_{FD}\)</span>, accounting for the (changing)
plasma current distribution:</p>
<div class="math notranslate nohighlight">
\[\begin{aligned}
\begin{split}
\psi^{[n]}\rvert_{\partial\Omega_{FD}}=&amp;\int_{\Omega_{p}} J_{\phi,pl}^{[n]}(\mathbf{P})\mathbf{G}_{\psi}^{\mathbf{P}}(\mathbf{p}) d\Omega_{p}
~~\forall \mathbf{p}\in \partial\Omega_{FD}
\end{split}\end{aligned}\]</div>
</div>
<div class="section" id="external-coils">
<h3>External coils<a class="headerlink" href="#external-coils" title="Permalink to this headline">¶</a></h3>
<p>The contributions of external coil currents are calculated using Green’s
functions for a point source with a toroidal current in cylindrical
axisymmetry.</p>
<p>The <span class="math notranslate nohighlight">\(\psi\)</span>, <span class="math notranslate nohighlight">\(B_x\)</span>, and <span class="math notranslate nohighlight">\(B_z\)</span> contributions from a
number <span class="math notranslate nohighlight">\(n_{C}\)</span> of external circular coils may be evaluated on the
domain, at a position (<span class="math notranslate nohighlight">\(X, Z\)</span>) as:</p>
<div class="math notranslate nohighlight" id="equation-psixz">
<span class="eqno">(10)<a class="headerlink" href="#equation-psixz" title="Permalink to this equation">¶</a></span>\[\psi(X, Z)=\sum_i^{n_C} I_i\mathbf{G}_{\psi}^{\mathbf{P_i}}(X, Z)\]</div>
<div class="math notranslate nohighlight" id="equation-bxxz">
<span class="eqno">(11)<a class="headerlink" href="#equation-bxxz" title="Permalink to this equation">¶</a></span>\[B_x(X, Z)=\sum_i^{n_C} I_i\mathbf{G}_{B_x}^{\mathbf{P_i}}(X, Z)\]</div>
<div class="math notranslate nohighlight" id="equation-bzxz">
<span class="eqno">(12)<a class="headerlink" href="#equation-bzxz" title="Permalink to this equation">¶</a></span>\[B_z(X, Z)=\sum_i^{n_C} I_i\mathbf{G}_{B_z}^{\mathbf{P_i}}(X, Z)\]</div>
<p>Where <span class="math notranslate nohighlight">\(\mathbf{G}_{\psi}^{\mathbf{P}}\)</span>,
<span class="math notranslate nohighlight">\(\mathbf{G}_{B_x}^{\mathbf{P}}\)</span>, and
<span class="math notranslate nohighlight">\(\mathbf{G}_{B_z}^{\mathbf{P}}\)</span> are Green’s functions for
<span class="math notranslate nohighlight">\(\psi\)</span>, <span class="math notranslate nohighlight">\(B_x\)</span>, and <span class="math notranslate nohighlight">\(B_z\)</span> for a unit current at
position <span class="math notranslate nohighlight">\(\mathbf{P} \equiv (X_c, Z_c)\)</span>, see Appendix 1. The
external coils can be discretised into many uniformly distributed point
sources of current, for additional precision. This is particularly
important when dealing with low aspect ratio rectangular coils, such as
for central solenoids.</p>
<p>The total poloidal magnetic flux is calculated on <span class="math notranslate nohighlight">\(\Omega_{FD}\)</span> by
summing the contributions of the plasma (from solving Equation
<a class="reference internal" href="#equation-fd">(8)</a> for <span class="math notranslate nohighlight">\(\psi\)</span>) and the external coils (Equation
<a class="reference internal" href="#equation-psixz">(10)</a>).</p>
</div>
<div class="section" id="plasma-boundary-identification">
<h3>Plasma boundary identification<a class="headerlink" href="#plasma-boundary-identification" title="Permalink to this headline">¶</a></h3>
<p>The plasma boundary is identified by the relative positions and magnetic
flux values of the various O-points, X-points, and limiter points.</p>
<p>First, an algorithm is used to find all the O- and X-points on the grid,
which effectively finds the exact locations where:</p>
<div class="math notranslate nohighlight">
\[\lvert \nabla \psi \rvert^2 = 0\]</div>
<p>All local minima in <span class="math notranslate nohighlight">\(\lvert \nabla \psi \rvert^2\)</span> on
<span class="math notranslate nohighlight">\(\Omega_{FD}\)</span> are found, with further searches using local
minimisation techniques being conducted if the poloidal magnetic field
is found to be below a certain low value, to find the exact locations of
the magnetic null-field points.</p>
<p>The null-field points are then separated into O- and X-points by the
signs of their second derivatives, as per <a class="reference internal" href="#johnson-1979" id="id8"><span>[Johnson_1979]</span></a>:</p>
<div class="math notranslate nohighlight">
\[S(\mathbf{P}) = \bigg(\frac{\partial^2\psi}{\partial X^2}\bigg)\bigg(\frac{\partial^2\psi}{\partial Z^2}\bigg)-\bigg(\frac{\partial^2\psi}{\partial X \partial Z}\bigg)\]</div>
<p>where a field null <span class="math notranslate nohighlight">\(\mathbf{P}\)</span> is an O-point if
<span class="math notranslate nohighlight">\(S(\mathbf{P})&gt;0\)</span> and an X-point if <span class="math notranslate nohighlight">\(S(\mathbf{P})&lt;0\)</span>.</p>
<p>The O-point the closest to the desired plasma magnetic axis is selected,
and the magnetic flux at this point is denoted <span class="math notranslate nohighlight">\(\psi_a\)</span>.</p>
<p>Then, the X-points and limiter points are sorted in <span class="math notranslate nohighlight">\(\psi\)</span>-space,
in decreasing order from the point with magnetic flux closest to
<span class="math notranslate nohighlight">\(\psi_a\)</span>.</p>
<p>To avoid picking up spurious X-points or limiters, the ordered list of
points is searched again in order, to check that the evolution of
<span class="math notranslate nohighlight">\(\psi\)</span> in space monotonically decreases from the O-point to the
point in question, following an approach used in FreeGS
<a class="reference internal" href="#dudson-2019" id="id9"><span>[Dudson_2019]</span></a>. The first such point fulfilling
this condition is selected as the plasma delimiting point, and its
magnetic flux is denoted as <span class="math notranslate nohighlight">\(\psi_b\)</span>.</p>
<p>The 2-D boundary of the flux surface crossing the plasma delimiting
point, <span class="math notranslate nohighlight">\(\partial\Omega_p\)</span>, is used to denote the plasma region,
<span class="math notranslate nohighlight">\(\Omega_{p}\)</span>. A simple 2-D ray-tracing algorithm is used to
populate a masking matrix, <span class="math notranslate nohighlight">\(\mathbf{M}\)</span>, in <span class="math notranslate nohighlight">\(\Omega_{FD}\)</span>,
such that:</p>
<div class="math notranslate nohighlight" id="equation-masking">
<span class="eqno">(13)<a class="headerlink" href="#equation-masking" title="Permalink to this equation">¶</a></span>\[\begin{split}\mathbf{M}_{n_x \times n_z} =
  \begin{cases}
  1 &amp; \textrm{if}~\mathbf{p} \in \Omega_{p} ~~\forall \mathbf{p} \in \Omega_{FD}\\
  0 &amp; \textrm{otherwise}
  \end{cases}\end{split}\]</div>
<p>This matrix is used to bound the plasma current and pressure terms on
the grid, ensuring that such terms are only non-zero in
<span class="math notranslate nohighlight">\(\Omega_{p}\)</span>.</p>
</div>
</div>
<div class="section" id="application-to-reactor-design">
<h2>Application to reactor design<a class="headerlink" href="#application-to-reactor-design" title="Permalink to this headline">¶</a></h2>
<div class="section" id="plasma-profiles">
<h3>Plasma profiles<a class="headerlink" href="#plasma-profiles" title="Permalink to this headline">¶</a></h3>
<p>The 1-D plasma profiles for toroidal current density and pressure are determined by the
flux functions <span class="math notranslate nohighlight">\(FF'\)</span> and <span class="math notranslate nohighlight">\(p'\)</span>.</p>
<p>Two approaches to determining the flux functions are available:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">CustomProfile</span></code> can be used to set the flux functions to fixed values, regardless of
the plasma geometry. This is useful when loading experimental profiles, or using
profiles from 1.5-D transport and fixed boundary equilibrium solvers.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">BetaIpProfile</span></code> can be used to constrain plasma integral parameters <span class="math notranslate nohighlight">\(\beta_p\)</span>,
<span class="math notranslate nohighlight">\(I_p\)</span>, and optionally <span class="math notranslate nohighlight">\(l_i\)</span>, see elsewhere. The flux function shape
parameterisation can be selected, and the parameters are optimised to meet the
integral constraints.</p>
<p>The 1-D plasma current and pressure profile parameterisations must be
chosen to satisfy some integral parameters based on a given reactor
design. A typical approach, see e.g. <a class="reference internal" href="#albanese-1998" id="id10"><span>[Albanese_1998]</span></a>, <a class="reference internal" href="#albanese-2018" id="id11"><span>[Albanese_2018]</span></a>,
is to constrain the plasma current, <span class="math notranslate nohighlight">\(I_p\)</span>, the ratio of the plasma
pressure to the poloidal magnetic field pressure, <span class="math notranslate nohighlight">\(\beta_{p}\)</span>, and
the normalised internal plasma inductance, <span class="math notranslate nohighlight">\(l_i\)</span>.</p>
<div class="math notranslate nohighlight" id="equation-ip">
<span class="eqno">(14)<a class="headerlink" href="#equation-ip" title="Permalink to this equation">¶</a></span>\[I_p = \int_{\Omega_p} J_{\phi} d\Omega_p\]</div>
<div class="math notranslate nohighlight" id="equation-betap">
<span class="eqno">(15)<a class="headerlink" href="#equation-betap" title="Permalink to this equation">¶</a></span>\[\beta_p = \frac{\langle p \rangle}{B_p^2/2\mu_0} = \frac{4}{\mu_0R_0I_p^2}\int_{\Omega_p} p d\Omega_p\]</div>
<div class="math notranslate nohighlight" id="equation-li">
<span class="eqno">(16)<a class="headerlink" href="#equation-li" title="Permalink to this equation">¶</a></span>\[l_i = \frac{4}{\mu_0R_0I_p^2}\int_{\Omega_p} \frac{\lvert\lvert B_p^2\rvert\rvert}{2\mu_0} d\Omega_p\]</div>
<p>From Equations <a class="reference internal" href="#equation-jphi">(4)</a> and <a class="reference internal" href="#equation-betap">(15)</a>, following an approach
taken in <a class="reference internal" href="#jeon-2015" id="id12"><span>[Jeon_2015]</span></a>, we can determine two
of the unknowns, <span class="math notranslate nohighlight">\(\lambda\)</span> and <span class="math notranslate nohighlight">\(\beta_0\)</span>, thus ensuring that
the <span class="math notranslate nohighlight">\(I_p\)</span> and <span class="math notranslate nohighlight">\(\beta_p\)</span> constraints are met, as in done in
e.g. <a class="reference internal" href="#jeon-2015" id="id13"><span>[Jeon_2015]</span></a>, <a class="reference internal" href="#dudson-2019" id="id14"><span>[Dudson_2019]</span></a>.</p>
<p>To enforce the <span class="math notranslate nohighlight">\(l_i\)</span> constraint, one must determine the shape
parameters, <span class="math notranslate nohighlight">\(\boldsymbol{\alpha}\)</span>, of the selected flux function. As the
plasma shape is irregular and varies during each iteration of the
Grad-Shafranov solution, a minimisation problem is set up during each
Grad-Shafranov iteration, in order to find the optimal shape parameter
vector <a class="footnote-reference brackets" href="#id36" id="id15">3</a>, <span class="math notranslate nohighlight">\(\boldsymbol{\alpha^{*}}\)</span>:</p>
<div class="math notranslate nohighlight" id="equation-liopt">
<span class="eqno">(17)<a class="headerlink" href="#equation-liopt" title="Permalink to this equation">¶</a></span>\[\begin{split}\begin{aligned}
\boldsymbol{\alpha^{*}}~=~&amp; \underset{\boldsymbol{\alpha}}{\text{minimise}}:
&amp; &amp; \bigg{\lvert}l_{i_{target}}-\frac{4}{\mu_0 R_0 I_p^2}\int_{\Omega_p}\frac{\lvert\lvert B_p^2\rvert\rvert}{2\mu_0} d\Omega_p \bigg{\rvert}\\
\end{aligned}\end{split}\]</div>
<p>Constraints may be applied to <span class="math notranslate nohighlight">\(\boldsymbol{\alpha}\)</span> in order to impose
certain current and/or pressure profiles, and to improve convergence.</p>
</li>
</ul>
</div>
<div class="section" id="equilibrium-constraints">
<h3>Equilibrium constraints<a class="headerlink" href="#equilibrium-constraints" title="Permalink to this headline">¶</a></h3>
<p>In order to find an optimal set of currents that produce a certain equilibrium, it is
common to apply a set of magnetic constraints to the equilibrium problem. These can be
based on measurements from experiments or based on some design criteria the user wishes
to meet.</p>
<p>A <code class="docutils literal notranslate"><span class="pre">MagneticConstraintSet</span></code> can be sub-classed or initialised with <code class="docutils literal notranslate"><span class="pre">MagneticConstraints</span></code>.</p>
<p>Two categories of magnetic constraints are supported: absolute and relative magnetic
constraints.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">bluemira.equilibria.constraints</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">MagneticConstraintSet</span><span class="p">,</span>
    <span class="n">FieldNullConstraint</span><span class="p">,</span>
    <span class="n">PsiConstraint</span><span class="p">,</span>
    <span class="n">IsofluxConstraint</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">magnetic_constraints</span> <span class="o">=</span> <span class="n">MagneticConstraintSet</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">FieldNullConstraint</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">z</span><span class="o">=-</span><span class="mi">6</span><span class="p">),</span>
        <span class="n">IsofluxConstraint</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">]),</span> <span class="n">z</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">6</span><span class="p">]),</span> <span class="n">ref_x</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">ref_z</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">),</span>
        <span class="n">PsiConstraint</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">z</span><span class="o">=-</span><span class="mi">6</span><span class="p">,</span> <span class="n">target_value</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span>
    <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We recommend you sub-class <code class="docutils literal notranslate"><span class="pre">MagneticConstraintSet</span></code> such that a parametric set of
magnetic constraints applicable to your problem can directly be used. Some common
plasma LCFS shape parameterisations are provided to assist you.</p>
</div>
<p>In the example below, a series of constraints is defined to produce a desired plasma
shape, which we specify in terms of <span class="math notranslate nohighlight">\(R_0\)</span>, <span class="math notranslate nohighlight">\(A\)</span>,
<span class="math notranslate nohighlight">\(\kappa\)</span>, and <span class="math notranslate nohighlight">\(\delta\)</span> using the Johner parameterisation
<a class="reference internal" href="#johner-2011" id="id16"><span>[Johner_2011]</span></a>. This parameterisation can
handle single and double null plasma shapes, and can be used to make
up-down and in-out asymmetric boundary shapes.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bluemira.equilibria.constraints</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">MagneticConstraintSet</span><span class="p">,</span>
    <span class="n">FieldNullConstraint</span><span class="p">,</span>
    <span class="n">IsofluxConstraint</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">bluemira.equilibria.shapes</span> <span class="kn">import</span> <span class="n">flux_surface_johner</span>


<span class="k">class</span> <span class="nc">ClassicalSNConstraints</span><span class="p">(</span><span class="n">MagneticConstraintSet</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">R_0</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">kappa_upper</span><span class="p">,</span> <span class="n">kappa_lower</span><span class="p">,</span> <span class="n">delta_upper</span><span class="p">,</span> <span class="n">delta_lower</span><span class="p">,</span> <span class="n">n_points</span><span class="o">=</span><span class="mi">40</span>
    <span class="p">):</span>

        <span class="n">shape</span> <span class="o">=</span> <span class="n">flux_surface_johner</span><span class="p">(</span>
            <span class="n">R_0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="n">R_0</span> <span class="o">/</span> <span class="n">A</span><span class="p">,</span>
            <span class="n">kappa_upper</span><span class="p">,</span>
            <span class="n">kappa_lower</span><span class="p">,</span>
            <span class="n">delta_upper</span><span class="p">,</span>
            <span class="n">delta_lower</span><span class="p">,</span>
            <span class="n">psi_u_neg</span><span class="o">=</span><span class="mi">180</span><span class="p">,</span>
            <span class="n">psi_u_pos</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
            <span class="n">psi_l_neg</span><span class="o">=-</span><span class="mi">120</span><span class="p">,</span>
            <span class="n">psi_l_pos</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
            <span class="n">upper</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">n</span><span class="o">=</span><span class="n">n_points</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">isoflux</span> <span class="o">=</span> <span class="n">IsofluxConstraint</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">shape</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">shape</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">ref_x</span><span class="o">=</span><span class="n">shape</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ref_z</span><span class="o">=</span><span class="n">shape</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">xpoint</span> <span class="o">=</span> <span class="n">FieldNullConstraint</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">R_0</span> <span class="o">-</span> <span class="n">delta_lower</span> <span class="o">*</span> <span class="n">R_0</span> <span class="o">/</span> <span class="n">A</span><span class="p">,</span> <span class="n">z</span><span class="o">=-</span><span class="n">kappa_lower</span> <span class="o">*</span> <span class="n">R_0</span> <span class="o">/</span> <span class="n">A</span>
        <span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">([</span><span class="n">isoflux</span><span class="p">,</span> <span class="n">xpoint</span><span class="p">])</span>


<span class="n">my_sn</span> <span class="o">=</span> <span class="n">ClassicalSNConstraints</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mf">3.1</span><span class="p">,</span> <span class="mf">1.6</span><span class="p">,</span> <span class="mf">1.8</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">)</span>
<span class="n">my_sn</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
<p>A set of <span class="math notranslate nohighlight">\(n_T\)</span> constraints are applied on the calculated plasma
boundary, in the form of <span class="math notranslate nohighlight">\(\psi\)</span>, <span class="math notranslate nohighlight">\(B_x\)</span>, and <span class="math notranslate nohighlight">\(B_z\)</span>
constraints. The <span class="math notranslate nohighlight">\(\psi\)</span> values are set to a desired value,
<span class="math notranslate nohighlight">\(\psi_{b}\)</span>, at all points on the plasma boundary (typically
<span class="math notranslate nohighlight">\(\sim\)</span>40 to 150 points suffice), and a null field condition is
specified at the X-point: <span class="math notranslate nohighlight">\(B_x = 0, B_z = 0\)</span>. One can also specify
<span class="math notranslate nohighlight">\(\psi\)</span> constraints for the divertor legs, in order (for example)
to ensure that the positions of the divertor strike points remain more
or less fixed over the course of a pulse. Equations <a class="reference internal" href="#equation-psixz">(10)</a>,
<a class="reference internal" href="#equation-bxxz">(11)</a>, and <a class="reference internal" href="#equation-bzxz">(12)</a> are used to set up an equation of the
form:</p>
<div class="math notranslate nohighlight" id="equation-ax-b">
<span class="eqno">(18)<a class="headerlink" href="#equation-ax-b" title="Permalink to this equation">¶</a></span>\[\mathbf{GI} = \mathbf{b_{t}}-\mathbf{b_{p}}\]</div>
<p>where:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(\mathbf{G}\)</span> is a <span class="math notranslate nohighlight">\(n_T \times n_C\)</span> matrix of Green’s
functions evaluated at the control points</p></li>
<li><p><span class="math notranslate nohighlight">\(\mathbf{I}\)</span> is a <span class="math notranslate nohighlight">\(n_C\)</span> vector of external coil currents</p></li>
<li><p><span class="math notranslate nohighlight">\(\mathbf{b_{t}}\)</span> is a <span class="math notranslate nohighlight">\(n_T\)</span> vector of target values</p></li>
<li><p><span class="math notranslate nohighlight">\(\mathbf{b_{p}}\)</span> is a <span class="math notranslate nohighlight">\(n_T\)</span> vector of the contribution of
the passive currents (including the plasma) to the desired
constraints.</p></li>
</ul>
<p>A general, unconstrained solution to this minimisation problem proves
useful during the first few stages of non-linear iterations. As Zakharov
<a class="reference internal" href="#zakharov-1973" id="id17"><span>[Zakharov_1973]</span></a> and Lackner <a class="reference internal" href="#lackner-1976" id="id18"><span>[Lackner_1976]</span></a> note, the problem of the
determination of external currents to create an arbitrarily defined
plasma shape constitutes an ill-posed problem in the sense of Hadamard.
Following <a class="reference internal" href="#zakharov-1973" id="id19"><span>[Zakharov_1973]</span></a> and many others,
we use Tikhonov regularisation <a class="reference internal" href="#tikhonov-1977" id="id20"><span>[Tikhonov_1977]</span></a> on the
<span class="math notranslate nohighlight">\(\mathbf{L_2}\)</span>-norm of Equation <a class="reference internal" href="#equation-ax-b">(18)</a> to determine an
optimal set of currents, <span class="math notranslate nohighlight">\(\mathbf{I^{*}}\)</span>:</p>
<div class="math notranslate nohighlight" id="equation-tikhonov">
<span class="eqno">(19)<a class="headerlink" href="#equation-tikhonov" title="Permalink to this equation">¶</a></span>\[\begin{aligned}
\mathbf{I^*}~=~&amp; \underset{\mathbf{I}}{\text{minimise}}:
&amp; &amp; \lvert\lvert \mathbf{GI}-\mathbf{b_{t}}+\mathbf{b_{p}}\rvert\rvert_2^2+\lvert\lvert \boldsymbol{\Gamma}\mathbf{I} \rvert\rvert_2^2
\end{aligned}\]</div>
<p>where <span class="math notranslate nohighlight">\(\boldsymbol{\Gamma}\)</span> is the regularisation term taken to be a small
multiple <span class="math notranslate nohighlight">\((\sim10^{-7})\)</span> of the identity matrix. In the following
Equation <a class="reference internal" href="#equation-tikhonov">(19)</a> can be solved analytically as:</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <span class="math notranslate nohighlight">\(Ax-b\)</span> formulation of the constraints can be set up as an optimisation
objective or a constraint of the form <span class="math notranslate nohighlight">\(Ax-b &lt; value\)</span></p>
</div>
</div>
<div class="section" id="coil-current-force-and-field-constraints">
<span id="sec-eng-constraints"></span><h3>Coil current, force, and field constraints<a class="headerlink" href="#coil-current-force-and-field-constraints" title="Permalink to this headline">¶</a></h3>
<p>The CS and PF coils provide the external currents required to control
the position and shape of the plasma. In order to design a tokamak’s
magnetic cage, it is important to respect the design constraints
inherent to the CS and PF coils. The CS coils form part of the radial
build of the reactor, and for consistency with the rest of the reactor
design in the BLUEPRINT code, the thickness of the CS coils is held
constant. Depending on the vertical extent of a CS coil, the maximum
current, <span class="math notranslate nohighlight">\(I_{max}\)</span>, that a coil can safely carry is determined by
an indicative current density for a coil winding pack:
<span class="math notranslate nohighlight">\(I_{max}= A_{coil}J_{max}\)</span>. In principle, the PF coil currents are
not constrained by current limits (as they could be made arbitrarily
large, provided other constraints are met). In practice, however, it is
convenient not to have overly large PF coils, so a current limit is
specified for the PF coils as <span class="math notranslate nohighlight">\(I_{max} = \eta I_p\)</span>, where e.g.
<span class="math notranslate nohighlight">\(\eta = 1.4\)</span>. The size of the PF coils is dynamically adjusted
according to the maximum current required of them.</p>
<p>Superconductivity is fickle; in order to keep a material in a
superconducting state, the field, current density, and temperature must
be kept within an operational margin of certain material-dependent
limits. The current density constraints are applied as discussed above,
and the magnetic field at the coils is constrained to be below
<span class="math notranslate nohighlight">\(\mathbf{B_{max}}\)</span>, the vector of maximum fields at the
coils <a class="footnote-reference brackets" href="#id37" id="id21">4</a>. The temperature constraints are not addressed in this model;
it is assumed that the coils operate at their nominal temperatures
(which to some extent determines the value of <span class="math notranslate nohighlight">\(J_{max}\)</span>).</p>
<p>Large vertical <span class="math notranslate nohighlight">\(\mathbf{j} \times \mathbf{B}\)</span> forces are generated
in the coils which must be withstood by the coil cage structures <a class="footnote-reference brackets" href="#id38" id="id22">5</a>.
In superconducting tokamaks, the CS and PF coils are often mechanically
and thermally connected to the toroidal field (TF) coils, out of a
desire to minimise the thermal conduction paths to a large cryogenic
mass by connecting it to room temperature bodies at the fewest possible
locations. Given this, the forces on the magnets must be resisted by the
magnet cage as a whole, which is why, following <a class="reference internal" href="#albanese-2018" id="id23"><span>[Albanese_2018]</span></a>, we apply maximum value
constraints to the vertical force a single PF coil, total absolute
vertical force on all CS coils, and the vertical separation forces
between each module in the CS stack (tension only).</p>
<p>The aforementioned constraints can be applied to Equation
<a class="reference internal" href="#equation-tikhonov">(19)</a> to give:</p>
<div class="math notranslate nohighlight" id="equation-tikhonov-constrained">
<span class="eqno">(20)<a class="headerlink" href="#equation-tikhonov-constrained" title="Permalink to this equation">¶</a></span>\[\begin{split}\begin{aligned}
\mathbf{I^{*}}~=~ &amp; \underset{\mathbf{I}}{\text{minimise}}:
&amp; &amp; \lvert\lvert \mathbf{GI}-\mathbf{b_{t}}+\mathbf{b_{p}}\rvert\rvert_2^2+\lvert\lvert \boldsymbol{\Gamma}\mathbf{I} \rvert\rvert_2^2\\
&amp; \text{subject to}:
&amp; &amp; \lvert \mathbf{I} \rvert \preccurlyeq \mathbf{I_{max}} \\
&amp;&amp;&amp; \mathbf{B} \preccurlyeq \mathbf{B_{max}} \\
&amp;&amp;&amp; \lvert F_i\rvert \leq F_{PF_{max}}~~\text{for}~i \in [1, .., n_{PF}]\\
&amp;&amp;&amp; \big\lvert \sum_{j=1}^{n_{CS}} F_j \big\rvert \leq F_{CS_{tot_{max}}}\\
&amp;&amp;&amp; \sum_{i=1}^{j}F_{i}-\sum_{i=j}^{n_{CS}}F_{i} \leq F_{CS_{sep_{max}}} ~~ \text{for}~j \in [1, .., n_{CS}]
\end{aligned}\end{split}\]</div>
<p>This is a non-linear optimisation problem with a quadratic objective
function and linear and quadratic constraints. A sequential least
squares optimisation algorithm, SLSQP <a class="reference internal" href="#kraft-1988" id="id24"><span>[Kraft_1988]</span></a>, implemented in NLopt <a class="reference internal" href="#johnson-2018" id="id25"><span>[Johnson_2018]</span></a>, is used to solve Equation
<a class="reference internal" href="#equation-tikhonov-constrained">(20)</a>. Using the Jacobians of the objective and
constraint functions greatly improve the algorithm’s performance, see
Appendix 2 for details.</p>
<p>Note that the field constraints should actually be applied over the
entire cross-section of each coil, and not at individual locations. Such
an approach is complicated by our choice of Green’s functions over a
finite element method and, furthermore, would complicate the analytical
calculation of the Jacobian of the field constraints. Instead, we choose
to constrain the poloidal field at the centre of the inside edge of each
coil, where the field is generally the highest.</p>
</div>
<div class="section" id="coil-position-optimisation-and-constraints">
<h3>Coil position optimisation and constraints<a class="headerlink" href="#coil-position-optimisation-and-constraints" title="Permalink to this headline">¶</a></h3>
<p>A key decision when designing fusion reactors is where to place the PF
coils. While the ability to generate and control the desired plasma
shapes is an important consideration, so too is the positioning of the
ports and penetrations to the vacuum vessel, which cannot coincide with
the toroidally continuous PF coils. Future fusion reactors will be
remotely maintained and it is important to ensure adequate access to the
in-vessel components through the magnetic cage and into the vacuum
vessel. Both vertical maintenance (e.g. <a class="reference internal" href="#crofts-2016" id="id26"><span>[Crofts_2016]</span></a>) and horizontal sector maintenance (e.g. <a class="reference internal" href="#waganer-2006" id="id27"><span>[Waganer_2006]</span></a>) approaches
apply strong constraints to the positions of the PF coils, as do
penetrations for H&amp;CD and other auxiliary systems.</p>
<p>Using the leading code in the field (CREATE-NL+ <a class="reference internal" href="#albanese-2015" id="id28"><span>[Albanese_2015]</span></a>), Albanese et al. <a class="reference internal" href="#albanese-2018" id="id29"><span>[Albanese_2018]</span></a> tackle the problem of the
constrained optimisation of the position of the PF coils with an
exhaustive search on a combination of potential coil positions, chosen
from a finite set of acceptable positions. They apply some restrictions
on the proximity between coils based on engineering judgement, reducing
the total number of permutations that need to be explored.</p>
<p>Here, we adopt a different approach, choosing instead to optimise the
coil positions along a basis function. For this we take as an input from
the BLUEPRINT code the outer edge of the TF coil shape (which has been
optimised to meet toroidal field ripple constraints), from which we take
an offset spline as a basis along which to position the centre of the PF
coils. This basis function is parameterised such that a PF coil position
vector <span class="math notranslate nohighlight">\(\mathbf{L} \in [0, 1]\)</span> maps to coil positions in
<span class="math notranslate nohighlight">\(X, Z\)</span> space, see <a class="reference internal" href="#fig-l-constraints"><span class="std std-numref">Fig. 2</span></a>. Note that if a PF
coil ends up being relatively small, it could in principle be moved
closer to the TF coil than it’s centre position on the basis function
would imply, improving the quality of the result slightly. Out of
simplicity, we do include this manipulation in our procedure.</p>
<p>The coil position constraints are implemented by introducing exclusion
zones, segmenting the basis function along which the PF coils can be
positioned. If a coil is in an exclusion zone at the start of the
optimisation procedure, it is moved to the nearest acceptable position.
Each coil is then fixed to its “track” segment, with individual lower
and upper bounds (<span class="math notranslate nohighlight">\(L_{min}\)</span> and <span class="math notranslate nohighlight">\(L_{max}\)</span>) applied, see
<a class="reference internal" href="#fig-l-constraints"><span class="std std-numref">Fig. 2</span></a>. Note that this has a similar effect to
the engineering judgement applied in the Albanese procedure, in that it
reduces the breadth of the optimisation problem.</p>
<div class="figure align-default" id="fig-l-constraints">
<img alt="../_images/L_constraints_crop.png" src="../_images/L_constraints_crop.png" />
<p class="caption"><span class="caption-number">Fig. 2 </span><span class="caption-text">Diagram depicting the implementation of the coil position optimisation procedures (left); with no exclusion zones, and (right); with exclusion zones. Each PF coil is assigned an <span class="math notranslate nohighlight">\(L\)</span> value, with bounds <span class="math notranslate nohighlight">\(L_{min}\)</span> and <span class="math notranslate nohighlight">\(L_{max}\)</span>. The exclusion zones in this example were calculated in the BLUEPRINT code assuming a vertical maintenance approach.</span><a class="headerlink" href="#fig-l-constraints" title="Permalink to this image">¶</a></p>
</div>
<p>For the central solenoid, a similar approach to the one described above
is taken, except that we use a straight vertical line as the
<span class="math notranslate nohighlight">\(\mathbf{L}\)</span> vector basis and the divisions between the solenoid
modules are optimised rather than their centre locations. The implicit
design decision here is that the solenoid is a single vertical stack of
multiple modules (with only minimal gaps between modules). The radius
and thickness of the central solenoid are taken from the radial build of
a systems code solution, and the vertical position and extent of the
solenoid are calculated within the BLUEPRINT framework based on the size
of the toroidal field coils. Often, however, a fairly regular spacing of
modules in the central solenoid is desirable and reduces the
dimensionality of the optimisation problem significantly.</p>
<p>The following optimisation problem is then solved, this time using the
COBYLA optimisation algorithm <a class="reference internal" href="#powell-1994" id="id30"><span>[Powell_1994]</span></a>,
also implemented in NLopt <a class="reference internal" href="#johnson-2018" id="id31"><span>[Johnson_2018]</span></a>:</p>
<div class="math notranslate nohighlight" id="equation-position-constrained">
<span class="eqno">(21)<a class="headerlink" href="#equation-position-constrained" title="Permalink to this equation">¶</a></span>\[\begin{split}\begin{aligned}
\mathbf{L^{*}}~=~&amp; \underset{\mathbf{L}}{\text{minimise}}:
&amp; &amp; \lvert\lvert \mathbf{G^{L}I^{*}}-\mathbf{b_{t}}+\mathbf{b_{p}}\rvert\rvert_2^2+\lvert\lvert \boldsymbol{\Gamma}\mathbf{I} \rvert\rvert_2^2\\
&amp; \text{subject to}:
&amp; &amp; \mathbf{L} \geqq \mathbf{L_{min}}\\
&amp;&amp;&amp; \mathbf{L} \leqq \mathbf{L_{max}}\\
\end{aligned}\end{split}\]</div>
<div class="section" id="zonal-positioning-of-coils">
<h4>Zonal positioning of coils<a class="headerlink" href="#zonal-positioning-of-coils" title="Permalink to this headline">¶</a></h4>
<p>The above method functions very well when the positions of the coils can be reduced to a one dimensional problem. To be able to optimise a coil’s position in two dimensions, the process works similarly to the above, with a few modifications.</p>
<ul class="simple">
<li><p>Firstly instead of being fixed on a track, coils are fixed within a given region or zone.</p></li>
<li><p>Secondly the zone has edges that must be respected, leading to a maximum cross sectional size of a coil, based on its position within the zone.</p></li>
</ul>
<div class="section" id="normalisation">
<h5>Normalisation<a class="headerlink" href="#normalisation" title="Permalink to this headline">¶</a></h5>
<p>To achieve this we first normalise positions in two dimensions using an x-z cut method. The only current limitation on the method is the zone must be its own convex hull. The x-z cut method works as follows:</p>
<ol class="arabic simple">
<li><p>The maximum and minimum points of the zone in a given axis (z) are captured and the initial z coordinate is normalised to these limits.</p></li>
<li><p>The intersection points of the zone and a plane at 45<a href="#id40"><span class="problematic" id="id41">|deg|</span></a> to both axes, through the initial point [x,z], is calculated.</p></li>
<li><p>If there are 1 or 2 intersection points the x coordinate is normalised to the intersection limits.</p></li>
<li><p>If there are no intersection points then the intersection of the zone, and a plane through the second axis (x) at the x coordinate, is calculated. This last step is only required initially to capture points outside of the zone to move them to its edges.</p></li>
</ol>
<p>To reacquire the original coordinates the process is repeated with normalised coordinates using the initial maximum and minimum zone limits, and an initial plane through z in real space.</p>
<p>For simple shapes the conversion is shown below:</p>
<table class="docutils align-default" id="id39">
<caption><span class="caption-number">Table 1 </span><span class="caption-text">Conversion between real coordinates (x,z) and normalised coordinates (L) for three simple zones. The colourbar shows the sum of the converted coordinates.</span><a class="headerlink" href="#id39" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 100%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><div class="figure align-default">
<img alt="../_images/sq.png" src="../_images/sq.png" />
</div>
</td>
</tr>
<tr class="row-even"><td><div class="figure align-default">
<img alt="../_images/circ.png" src="../_images/circ.png" />
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="figure align-default">
<img alt="../_images/dia.png" src="../_images/dia.png" />
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="zone-boundaries">
<h5>Zone Boundaries<a class="headerlink" href="#zone-boundaries" title="Permalink to this headline">¶</a></h5>
<p>The cross sectional area of a coil is modelled as linearly dependent on the current that the coil will carry. Therefore by limiting the size of the coil to stay within the bounds of the zone we must limit the current a coil can carry. The maximum size a coil can take within a zone is calculated by calculating the largest inscribed rectangle. From this inscribed rectangle the maximum current can be calculated and fed into the current optimiser.</p>
</div>
</div>
<div class="section" id="circuits">
<h4>Circuits<a class="headerlink" href="#circuits" title="Permalink to this headline">¶</a></h4>
<p>If one wants to run the solver for double null equilibria, it might be
expected that such an equilbrium should be symmetrical about <span class="math notranslate nohighlight">\(z = 0\)</span>.
In this case, it makes sense for the coil positions to be up-down symmetric
and for them to carry the same current. In reality, these coils might be in an actual circuit
that allows them to be controlled simultaneously and maintain proportional currents.
To replicate this setup, a Circuit class treating a pair of up-down symmetric
coils as one has been developed. We instantiate a Circuit by specifying the position,
dimensions, and current of a coil in the upper hlaf plane. A <em>virtual</em> coil (with the same parameterisation
except mirrored position) is then considered in calculations by the equilibrium solver.
This second coil is considered identical in every way to the coil in the
upper half plane except with negative <span class="math notranslate nohighlight">\(z\)</span> position.</p>
<p>A Coilset object can then be populated with Circuits such that when the solver
intends to use a coil from this coilset for a calculation, it will take into
consideration a second identical coil that will influence the result. In particular,
this is useful when calculating fields semi-analytically or through the use of Green’s functions
and can be used throughout the solver to reduce the number of degrees of
freedom by halving the number of currents used to populate matrices used in optimisation calculations.
Throughout each iteration of the solver, each <em>virtual</em> coil in the lower
half plane will maintain the same current as its symmetrical counterpart,
resulting in a converged (or not) equilbrium that should be symmetric as a result
of a perfectly symmetrical system of coils to aid in convergence.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When solving purely symmetric equilibria with a symmetric <code class="docutils literal notranslate"><span class="pre">CoilSet</span></code>, we recommend
you use the <code class="docutils literal notranslate"><span class="pre">force_symmetry</span></code> flag in <code class="docutils literal notranslate"><span class="pre">Equilibrium</span></code>. This solves the
Grad-Shafranov equation on half of the FD grid, and mirrors the result to the other
half, resulting in a more stable solution. This approach presently only works for
grids centred around <code class="docutils literal notranslate"><span class="pre">z</span> <span class="pre">=</span> <span class="pre">0</span></code>.</p>
</div>
</div>
</div>
<div class="section" id="appendix-1-greens-functions-and-discretised-coils">
<h3>Appendix 1: Green’s functions and discretised coils<a class="headerlink" href="#appendix-1-greens-functions-and-discretised-coils" title="Permalink to this headline">¶</a></h3>
<p>The Green’s functions for poloidal magnetic flux, radial magnetic field,
and vertical magnetic field at a location <span class="math notranslate nohighlight">\((X, Z)\)</span> due to a unit
current source at location <span class="math notranslate nohighlight">\(\mathbf{P}\equiv (X_c,Z_c)\)</span>:</p>
<div class="math notranslate nohighlight" id="equation-greens-funcs">
<span class="eqno">(22)<a class="headerlink" href="#equation-greens-funcs" title="Permalink to this equation">¶</a></span>\[\begin{split}\begin{aligned}
\mathbf{G}_{\psi}^{\mathbf{P}}(X, Z)&amp;=\dfrac{{\mu}_{0}}{2{\pi}}a\big[(1-k/2)\textrm{K}(k)-\textrm{E}(k)\big]\\
\mathbf{G}_{B_x}^{\mathbf{P}}(X, Z)&amp;=\dfrac{{\mu}_{0}}{2{\pi}}
    \dfrac{(Z-Z_c)\big(T_2\big[(Z-Z_c)^2+X^2+X_c^2\big]-T_1\big)}{X}\\
\mathbf{G}_{B_z}^{\mathbf{P}}(X, Z)&amp;=\dfrac{{\mu}_{0}}{2{\pi}}
    \bigg[T_1+\bigg(X_c^2-X^2-(Z-Z_c)^2\bigg)T_2\bigg]\end{aligned}\end{split}\]</div>
<p>Where:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
a&amp;\equiv\sqrt{(X+X_{c})^{2}+(Z-Z_{c})^{2}} \\
k^{2}&amp;\equiv\dfrac{4XX_{c}}{a^2}\\
T_1&amp;\equiv\frac{\textrm{K}(k)}{a}\\
T_2&amp;\equiv\frac{\textrm{E}(k)}{a^3(1-k)}\end{aligned}\end{split}\]</div>
<p>And <span class="math notranslate nohighlight">\(\textrm{K}\)</span> and <span class="math notranslate nohighlight">\(\textrm{E}\)</span> are the complete elliptic
integrals of the first and second kind, respectively.</p>
<p>A coil at position <span class="math notranslate nohighlight">\(\mathbf{P_{C}}\)</span> can be discretised into
<span class="math notranslate nohighlight">\(n_{f}\)</span> individual current-carrying filaments at positions
<span class="math notranslate nohighlight">\(\mathbf{p_i}\)</span>, each with the same current.</p>
<div class="math notranslate nohighlight">
\[\mathbf{G}_{v}^{\mathbf{P_{C}}}(X, Z) = \frac{1}{n_{f}}\sum_i^{n_{f}}\mathbf{G}_{v}^{\mathbf{p_{i}}}(X, Z)\]</div>
<p>where:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(v\)</span> denotes one of <span class="math notranslate nohighlight">\([\psi, B_x, B_z]\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(\mathbf{p_i}\)</span> is the position of the subcoil <span class="math notranslate nohighlight">\(i\)</span></p></li>
</ul>
<p>In practice the coils are discretised based on their size (<span class="math notranslate nohighlight">\(dx\)</span>
and <span class="math notranslate nohighlight">\(dz\)</span>), to accommodate rectangular shaped coils.</p>
<p>Note that the Green’s functions in Equation <a class="reference internal" href="#equation-greens-funcs">(22)</a> diverge logarithmically as the evaluation point approaches the centre of the coil. For <span class="math notranslate nohighlight">\(\psi\)</span> this is not so important, as <span class="math notranslate nohighlight">\(\psi\)</span> is not required to be constrained inside a coil. However, this does cause issues when evaluating the field constraints on the coils, so a correction is required for <span class="math notranslate nohighlight">\(B_{x}\)</span> and <span class="math notranslate nohighlight">\(B_{z}\)</span>. This is done using a semi-analytic reduction of the 3-D Biot-Savart law for a circular coil with a rectangular cross-section developed in <a class="reference internal" href="#zhang-2012" id="id32"><span>[Zhang_2012]</span></a>:</p>
<div class="math notranslate nohighlight" id="equation-semianalytic">
<span class="eqno">(23)<a class="headerlink" href="#equation-semianalytic" title="Permalink to this equation">¶</a></span>\[\begin{split}\begin{aligned}
B_{x} &amp;= \dfrac{\mu_{0}J_{c}x_{c}}{2\pi} \sum_{i=1}^2 \sum_{j=1}^2 (-1)^{i+j}\mathcal{P}_{x}(X_i, Z_j) \\
B_{z} &amp;= \dfrac{\mu_{0}J_{c}x_{c}}{2\pi} \sum_{i=1}^2 \sum_{j=1}^2 (-1)^{i+j}\mathcal{P}_{z}(X_i, Z_j)\end{aligned}\end{split}\]</div>
<p>with:</p>
<div class="math notranslate nohighlight" id="equation-field-primitives">
<span class="eqno">(24)<a class="headerlink" href="#equation-field-primitives" title="Permalink to this equation">¶</a></span>\[\begin{split}\begin{aligned}
\mathcal{P}_{x}(X, Z) &amp;= \int_0^{\pi} \big(X_0+\text{cos}(\phi)\text{ln}(X_0+X-\text{cos}(\phi)\big) \text{cos}(\phi) d\phi\\
\mathcal{P}_{z}(X, Z) &amp;=  \int_0^{\pi} \bigg(Z\text{ln}(X_0+X-\text{cos}(\phi))+\dfrac{1}{2}\text{cos}(\phi)\text{ln}\dfrac{X_0-Z}{X_0+Z} -\text{sin}(\phi)\text{arctan}\dfrac{Z(R-\text{cos}(\phi))}{X_0 \text{sin}(\phi)}\bigg) d\phi\end{aligned}\end{split}\]</div>
<p>where:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(X_1 = \dfrac{x_{c}-dx_{c}}{x}\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(X_2 = \dfrac{x_{c}-dx_{c}}{x}\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(Z_1 = \dfrac{-dz_{c}-z}{x}\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(Z_2 = \dfrac{dz_{c}-z}{x}\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(X_0 = \sqrt{X^2+1-2X cos(\phi) + Z^2}\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(J_c =\)</span> coil current density [A/m <sup>2</sup>]</p></li>
<li><p><span class="math notranslate nohighlight">\(dx_c =\)</span> coil half-width in the <span class="math notranslate nohighlight">\(x\)</span> direction</p></li>
<li><p><span class="math notranslate nohighlight">\(dz_c =\)</span> coil half-height in the <span class="math notranslate nohighlight">\(z\)</span> direction</p></li>
</ul>
<p>Equation <a class="reference internal" href="#equation-field-primitives">(24)</a> is solved by numerical integration and used for
evaluation points inside the coils. This semi-analytic formulation does result in some
singularities which are treated analytically and numerically as described in
<a class="reference internal" href="#zhang-2012" id="id33"><span>[Zhang_2012]</span></a>.</p>
</div>
<div class="section" id="appendix-2-optimisation-jacobians">
<h3>Appendix 2: optimisation Jacobians<a class="headerlink" href="#appendix-2-optimisation-jacobians" title="Permalink to this headline">¶</a></h3>
<p>The vertical forces acting on the coils are calculated as:</p>
<div class="math notranslate nohighlight" id="equation-forces">
<span class="eqno">(25)<a class="headerlink" href="#equation-forces" title="Permalink to this equation">¶</a></span>\[\mathbf{F_z} = \mathbf{I}\circ (\mathbf{F_{a_{z}}}\cdot\mathbf{I}+\mathbf{F_{p_{z}}})\]</div>
<p>where:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(\mathbf{F_z}\)</span> is the <span class="math notranslate nohighlight">\(n_C\)</span> vector of the coil vertical
forces</p></li>
<li><p><span class="math notranslate nohighlight">\(\circ\)</span> is the Hadamard product</p></li>
<li><p><span class="math notranslate nohighlight">\(\mathbf{F_{a_{z}}}\)</span> is the <span class="math notranslate nohighlight">\(n_C \times n_C\)</span> response
matrix of the active coil forces</p></li>
<li><p><span class="math notranslate nohighlight">\(\mathbf{F_{p_{z}}}\)</span> is the <span class="math notranslate nohighlight">\(n_C\)</span> response vector of the
passive coil force contributions (including the plasma)</p></li>
</ul>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
F_{a_{z_{i,j}}}=-2\pi X_i \mathbf{G}^{\mathbf{P_{j}}}_{B_{x}}(X_i,Z_i)\\
F_{p_{z_{i}}}=-2\pi X_i \sum_{k=1}^{n_{P}} I_k\mathbf{G}^{\mathbf{P_{k}}}_{B_{x}}(X_i, Z_i)
\end{aligned}\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(n_P\)</span> is the number of passive coils (including the plasma,
which is discretised into many small coils).</p>
<p>The poloidal fields at the coils locations are calculated as:</p>
<div class="math notranslate nohighlight">
\[\mathbf{B} = \sqrt{(\mathbf{B_{a_{x}}}\mathbf{I}+\mathbf{B_{p_{x}}})^{\circ 2}+(\mathbf{B_{a_{z}}}\mathbf{I}+\mathbf{B_{p_{z}}})^{\circ 2}}\]</div>
<p>where:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(\mathbf{B}\)</span> is the <span class="math notranslate nohighlight">\(n_C\)</span> vector of the poloidal field
values at the coils</p></li>
<li><p><span class="math notranslate nohighlight">\(\mathbf{B_{a_{x}}}\)</span> and <span class="math notranslate nohighlight">\(\mathbf{B_{a_{z}}}\)</span> are the
<span class="math notranslate nohighlight">\(n_C \times n_C\)</span> coil response matrices of the radial and
vertical fields</p></li>
<li><p><span class="math notranslate nohighlight">\(\mathbf{B_{p_{p}}}\)</span> is the <span class="math notranslate nohighlight">\(n_C\)</span> response vector of the
passive coil poloidal field contributions (including the plasma)</p></li>
<li><p><span class="math notranslate nohighlight">\(\mathbf{B_{p_{x}}}\)</span> is the :math`n_C` response vector of the passive coil radial field contributions (including the plasma)</p></li>
<li><p><span class="math notranslate nohighlight">\(\mathbf{B_{p_{z}}}\)</span> is the <span class="math notranslate nohighlight">\($n_C\)</span> response vector of the passive coil vertical field contributions (including the plasma)</p></li>
</ul>
<p>Deterministic optimisation algorithms require information on the
gradient of the objective function and constraints. In the absence of
analytical gradients (Jacobian matrices) an optimiser will calculate
gradients numerically, requiring significantly more evaluations of the
objective function. Below we detail the calculation of the Jacobians for
the objective function, vertical force, and poloidal field, which are
used in the optimisation procedures described here.</p>
<p>The Jacobian of the objective function used in Equation
<a class="reference internal" href="#equation-tikhonov-constrained">(20)</a>:</p>
<div class="math notranslate nohighlight">
\[\dfrac{\partial \lvert\lvert \mathbf{G^{L}I}-\mathbf{b_{t}}+\mathbf{b_{p}}\rvert\rvert_2^2+\lvert\lvert \boldsymbol{\Gamma}\mathbf{I} \rvert\rvert_2^2}{\partial \mathbf{I}} = 2\mathbf{G^{L}}^{\intercal}\mathbf{G^{L}}\mathbf{I}-2\mathbf{G^{L}}(\mathbf{b_t}-\mathbf{b_p})+2\mathbf{\Gamma}\mathbf{I}\]</div>
<p>The Jacobian of the field calculation:</p>
<div class="math notranslate nohighlight">
\[\dfrac{\partial\mathbf{B}}{\partial \mathbf{I}} = \dfrac{\mathbf{B_{a_{x}}} \circ (\mathbf{B_{a_{x}}} \mathbf{I} + \mathbf{B_{p_{x}}}) + \mathbf{B_{a_{z}}} \circ (\mathbf{B_{a_{z}}}\mathbf{I} + \mathbf{B_{p_{z}}})}{\sqrt{(\mathbf{B_{a_{x}}}\mathbf{I}+\mathbf{B_{p_{x}}})^{\circ 2}+(\mathbf{B_{a_{z}}}\mathbf{I}+\mathbf{B_{p_{z}}})^{\circ 2}}}\]</div>
<p>The Jacobian of the force calculation:</p>
<div class="math notranslate nohighlight">
\[\dfrac{\partial\mathbf{F}}{\partial \mathbf{I}} = \mathbf{I}^{\intercal}\circ\mathbf{F_{a}}+\textrm{diag}(\mathbf{I}\circ\textrm{diag}(\mathbf{F_{a}})+\mathbf{F_{p}})\]</div>
<p>The gradients of the specific force and field inequality constraints
with respect to <span class="math notranslate nohighlight">\(\mathbf{I}\)</span> can be obtained from the above
Jacobians.</p>
<p class="rubric">Footnotes</p>
<dl class="footnote brackets">
<dt class="label" id="id34"><span class="brackets">1</span></dt>
<dd><p>Cryogenically-cooled normal conductors such as high purity Cu and Al
can also be considered, and can to some extent relax constraints on
the field at the coils (despite also exhibiting some
magneto-resistive effects) and come, naturally, at the price of some
resistive losses in the system.</p>
</dd>
<dt class="label" id="id35"><span class="brackets">2</span></dt>
<dd><p>Bearing in mind that the global reactor cost function should be
minimised over the full reactor design sequence.</p>
</dd>
<dt class="label" id="id36"><span class="brackets"><a class="fn-backref" href="#id15">3</a></span></dt>
<dd><p>In the following, we use the superscript <span class="math notranslate nohighlight">\(^{*}\)</span> to indicate
optimality.</p>
</dd>
<dt class="label" id="id37"><span class="brackets"><a class="fn-backref" href="#id21">4</a></span></dt>
<dd><p>In principle the maximum field constraint on a coil could be higher
if it were carrying less current, as its margin to superconducting
quench would be higher. We ignore this in our model, out of
convenience and conservativism.</p>
</dd>
<dt class="label" id="id38"><span class="brackets"><a class="fn-backref" href="#id22">5</a></span></dt>
<dd><p>The radial <span class="math notranslate nohighlight">\(\mathbf{j} \times \mathbf{B}\)</span> forces are resisted
by tension of the circular coils, giving rise to a hoop stress but
generally not transferring the force to rest of the magnet cage and
structure (provided the radial forces are uniformally distributed).</p>
</dd>
</dl>
<p class="rubric">References</p>
<dl class="citation">
<dt class="label" id="shafranov-1957"><span class="brackets"><a class="fn-backref" href="#id1">Shafranov_1957</a></span></dt>
<dd><p>V.D. Shafranov, On magnetohydrodynamical equilibrium configurations, J. Exp. Theor. Phys. (U.S.S.R.) 33 (1957) 710–722</p>
</dd>
<dt class="label" id="grad-1958"><span class="brackets"><a class="fn-backref" href="#id2">Grad_1958</a></span></dt>
<dd><ol class="upperalpha simple" start="8">
<li><p>Grad, H. Rubin, Hydromagnetic equilibria and force-free fields, J. Nucl. Energy (1954) 7 (September) (1958) 284–285</p></li>
</ol>
</dd>
<dt class="label" id="luxon-1982"><span class="brackets">Luxon_1982</span><span class="fn-backref">(<a href="#id3">1</a>,<a href="#id4">2</a>)</span></dt>
<dd><p>J.L. Luxon, B.B. Brown, Magnetic analysis of non-circular cross-section tokamaks, Nucl. Fusion 22 (June) (1982) 813–821</p>
<dt class="label" id="lao-1985"><span class="brackets"><a class="fn-backref" href="#id5">Lao_1985</a></span></dt>
<dd><p>L.H. Lao, S. John, R. Stambaugh, A. Kellman, W. Pfeiffer, Reconstruction of current profile parameters and plasma shapes in tokamaks, Nucl. Fusion 25 (November) (1985) 1611–1622</p>
</dd>
</dl>
</dd>
<dl class="citation">
<dt class="label" id="jeon-2015"><span class="brackets">Jeon_2015</span><span class="fn-backref">(<a href="#id6">1</a>,<a href="#id12">2</a>,<a href="#id13">3</a>)</span></dt>
<dd><p>Y.M. Jeon, Development of a free-boundary tokamak equilibrium solver for advanced study of tokamak equilibria, J. Korean Phys. Soc. 67 (September) (2015) 843–853</p>
</dd>
<dt class="label" id="dudson-2019"><span class="brackets">Dudson_2019</span><span class="fn-backref">(<a href="#id7">1</a>,<a href="#id9">2</a>,<a href="#id14">3</a>)</span></dt>
<dd><ol class="upperalpha simple" start="2">
<li><p>Dudson, FreeGS: Free Boundary Grad-Shafranov Solver, (2019) June &lt;<a class="reference external" href="https://github.com/bendudson/freegs">https://github.com/bendudson/freegs</a>&gt;</p></li>
</ol>
</dd>
<dt class="label" id="johnson-1979"><span class="brackets"><a class="fn-backref" href="#id8">Johnson_1979</a></span></dt>
<dd><p>J.L. Johnson, H.E. Dalhed, J.M. Greene, R.C. Grimm, Y.Y. Hsieh, S.C. Jardin, J. Manickam, M. Okabayashi, R.G. Storer, A.M.M. Todd, D.E. Voss, K.E. Weimer, Numerical determination of axisymmetric toroidal magnetohydrodynamic equilibria, J. Comput. Phys. 32 (August) (1979) 212–234</p>
</dd>
<dt class="label" id="albanese-1998"><span class="brackets"><a class="fn-backref" href="#id10">Albanese_1998</a></span></dt>
<dd><ol class="upperalpha simple" start="18">
<li><p>Albanese, F. Villone, The linearized CREATE-L plasma response model for the control of current, position and shape in tokamaks, Nucl. Fusion 38 (May) (1998) 723–738</p></li>
</ol>
</dd>
<dt class="label" id="albanese-2018"><span class="brackets">Albanese_2018</span><span class="fn-backref">(<a href="#id11">1</a>,<a href="#id23">2</a>,<a href="#id29">3</a>)</span></dt>
<dd><ol class="upperalpha simple" start="18">
<li><p>Albanese, R. Ambrosino, A. Castaldo, V.P. Loschiavo, Optimization of the PF coil system in axisymmetric fusion devices, Fusion Eng. Des. 133 (August) (2018) 163–172</p></li>
</ol>
</dd>
<dt class="label" id="johner-2011"><span class="brackets"><a class="fn-backref" href="#id16">Johner_2011</a></span></dt>
<dd><ol class="upperalpha simple" start="10">
<li><p>Johner, HELIOS: a zero-dimensional tool for next step and reactor studies, Fusion Sci. Technol. 59 (February) (2011) 308–349</p></li>
</ol>
</dd>
<dt class="label" id="zakharov-1973"><span class="brackets">Zakharov_1973</span><span class="fn-backref">(<a href="#id17">1</a>,<a href="#id19">2</a>)</span></dt>
<dd><ol class="upperalpha simple" start="12">
<li><p>Zakharov, Numerical methods for solving some problems of the theory of plasma equilibrium in toroidal configurations, Nucl. Fusion 13 (August) (1973) 595–602</p></li>
</ol>
</dd>
<dt class="label" id="lackner-1976"><span class="brackets"><a class="fn-backref" href="#id18">Lackner_1976</a></span></dt>
<dd><ol class="upperalpha simple" start="11">
<li><p>Lackner, Computation of ideal MHD equilibria, Comput. Phys. Commun. 12 (September) (1976) 33–44</p></li>
</ol>
</dd>
<dt class="label" id="tikhonov-1977"><span class="brackets"><a class="fn-backref" href="#id20">Tikhonov_1977</a></span></dt>
<dd><p>A.N. Tikhonov, V.I. Arsenin, Solutions of Ill-Posed Problems, Winston, 1977</p>
</dd>
<dt class="label" id="kraft-1988"><span class="brackets"><a class="fn-backref" href="#id24">Kraft_1988</a></span></dt>
<dd><ol class="upperalpha simple" start="4">
<li><p>Kraft, A Software Package for Sequential Quadratic Programming, Tech. Rep.DFVLR-FB 88-28, Deutsche Forschungs- und Versuchsanstalt für Luft- und Raumfahrt, 1988.</p></li>
</ol>
</dd>
<dt class="label" id="johnson-2018"><span class="brackets">Johnson_2018</span><span class="fn-backref">(<a href="#id25">1</a>,<a href="#id31">2</a>)</span></dt>
<dd><p>S.G. Johnson, The NLopt Nonlinear-Optimization Package, (2018)</p>
</dd>
<dt class="label" id="crofts-2016"><span class="brackets"><a class="fn-backref" href="#id26">Crofts_2016</a></span></dt>
<dd><ol class="upperalpha simple" start="15">
<li><p>Crofts, A. Loving, D. Iglesias, M. Coleman, M. Siuko, M. Mittwollen, V. Queral, A. Vale, E. Villedieu, Overview of progress on the European DEMO remote maintenance strategy, Fusion Eng. Des. 109–111 (November) (2016) 1392–1398</p></li>
</ol>
</dd>
<dt class="label" id="waganer-2006"><span class="brackets"><a class="fn-backref" href="#id27">Waganer_2006</a></span></dt>
<dd><p>L.M. Waganer, ARIES-, maintenance system definition and analysis, Fusion Eng. Des. 80 (January) (2006) 161–180</p>
</dd>
<dt class="label" id="albanese-2015"><span class="brackets"><a class="fn-backref" href="#id28">Albanese_2015</a></span></dt>
<dd><ol class="upperalpha simple" start="18">
<li><p>Albanese, R. Ambrosino, M. Mattei, CREATE-NL+: a robust control-oriented free boundary dynamic plasma equilibrium solver, Fusion Eng. Des. 96–97 (October) (2015) 664–667</p></li>
</ol>
</dd>
<dt class="label" id="powell-1994"><span class="brackets"><a class="fn-backref" href="#id30">Powell_1994</a></span></dt>
<dd><p>M.J.D. Powell, A direct search optimization method that models the objective and constraint functions by linear interpolation, in: S. Gomez, J.-P. Hennart (Eds.), Advances in Optimization and Numerical Analysis, Mathematics and Its Applications, Springer Netherlands, Dordrecht, 1994, pp. 51–67</p>
</dd>
<dt class="label" id="zhang-2012"><span class="brackets">Zhang_2012</span><span class="fn-backref">(<a href="#id32">1</a>,<a href="#id33">2</a>)</span></dt>
<dd><ol class="upperalpha simple" start="4">
<li><p>Zhang, C. S. Koh, An Efficient Semianalytic Computation Method of Magnetic Field for a Circular Coil With Rectangular Cross Section, IEEE Transactions on Magnetics, 2012, pp. 62-68</p></li>
</ol>
</dd>
</dl>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="../geometry.html" class="btn btn-neutral float-right" title="geometry" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="../base.html" class="btn btn-neutral float-left" title="base" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, M. Coleman, J. Cook, F. Franza, I. Maione, S. McIntosh, J. Morris, D. Short.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>